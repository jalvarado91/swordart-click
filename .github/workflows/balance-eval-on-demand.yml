name: Balance Eval (On Demand)

on:
  workflow_dispatch:
    inputs:
      include_prestige:
        description: "Run evaluate:prestige (120m, max 2 prestiges)"
        required: true
        type: boolean
        default: true

jobs:
  evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run evaluation matrix
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p artifacts

          bun run evaluate:optimal | tee artifacts/evaluate-optimal.txt
          bun run evaluate:human | tee artifacts/evaluate-human.txt
          bun run evaluate:idle | tee artifacts/evaluate-idle.txt

          if [[ "${{ inputs.include_prestige }}" == "true" ]]; then
            bun run evaluate:prestige | tee artifacts/evaluate-prestige.txt
          fi

      - name: Type check
        shell: bash
        run: |
          set -euo pipefail
          bunx tsc --noEmit | tee artifacts/tsc.txt

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          bun run build | tee artifacts/build.txt

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: balance-eval-logs-${{ github.run_number }}
          path: artifacts/
          if-no-files-found: error
